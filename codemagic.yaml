workflows:
  android-release:
    name: Android Release Build
    environment:
      groups:
        - keystore  # Contains signing keys
      vars:
         GRADLE_OPTS: "-Dorg.gradle.daemon=false -Xmx4096m"
    scripts:
      - name: Setup Environment
        script: |
          echo "=== Starting Environment Setup ==="
          
          # 1. Create directories with verification
          echo "Creating build directories..."
          if ! mkdir -p build/logs build/outputs/apk; then
            echo "Failed to create directories!"
            echo "Current working directory: $(pwd)"
            echo "Directory permissions:"
            ls -ld $(pwd) build || true
            exit 1
          fi
          
          # 2. Verify directory creation
          echo "Verifying directories exist..."
          if [ ! -d "build/logs" ] || [ ! -d "build/outputs/apk" ]; then
            echo "Directories not created!"
            echo "Directory structure:"
            find . -type d | grep -v '.git' || true
            exit 1
          fi
          
          # 3. Java setup with fallbacks
          echo "Configuring Java environment..."
          JAVA_HOME=$(/usr/libexec/java_home -v 11 2>/dev/null || /usr/libexec/java_home -v 17 2>/dev/null || echo "")
          if [ -z "$JAVA_HOME" ]; then
            echo "No Java installation found"
            echo "Available Java versions:"
            /usr/libexec/java_home -V || true
            exit 1
          fi
          
          echo "Using JAVA_HOME: $JAVA_HOME"
          echo "JAVA_HOME=$JAVA_HOME" >> $CM_ENV
          java -version 2>&1 | tee build/logs/java_version.log
          
          # 4. Final verification
          echo "=== Setup Complete ==="
          echo "Directory structure:"
          ls -lR build || true
          echo "Environment variables:"
          printenv | grep -E 'JAVA_HOME|GRADLE|ANDROID' || true


      # ======================
      # 2. GRADLE CONFIGURATION  
      # ======================
      - name: Configure Gradle
        script: |
          echo "=== Gradle Setup ==="
          cd android
          # Force Gradle 8.0
          sed -i.bak 's|distributionUrl=.*|distributionUrl=https\://services.gradle.org/distributions/gradle-8.0-all.zip|' gradle/wrapper/gradle-wrapper.properties
          
          # Update Android Gradle Plugin
          sed -i.bak 's|com.android.tools.build:gradle:[0-9.]*|com.android.tools.build:gradle:8.0.0|' build.gradle
          
          # Set Java 11 compatibility
          echo "android { compileOptions { sourceCompatibility JavaVersion.VERSION_11; targetCompatibility JavaVersion.VERSION_11 } }" >> app/build.gradle
          
          ./gradlew --version
          cd ..

      # ======================
      # 3. DEPENDENCY RESOLUTION
      # ======================
      - name: Resolve Dependencies
        script: |
          echo "=== Dependency Check ==="
          flutter pub get
          cd android
          ./gradlew :app:dependencies --configuration releaseRuntimeClasspath > ../build/logs/dependencies.txt
          cd ..
          echo "Problematic dependencies:"
          grep -i "conflict\|incompatible" build/logs/dependencies.txt || echo "No conflicts found"

      # ======================
      # 4. BUILD PROCESS
      # ======================
      - name: Run Build with Debug
        script: |
          echo "=== Starting Build ===" | tee build/logs/build.log
          flutter clean >> build/logs/build.log 2>&1
          
          # Run Gradle build with proper log handling
          cd android
          {
            ./gradlew clean assembleRelease \
              --no-daemon \
              --stacktrace \
              --info \
              --scan \
              --console=plain 2>&1 | tee ../build/logs/gradle.log
          } || {
            echo "=== GRADLE BUILD FAILED ===" | tee -a ../build/logs/build.log
            echo "Last 50 lines:" | tee -a ../build/logs/build.log
            tail -n 50 ../build/logs/gradle.log | tee -a ../build/logs/build.log
            echo "Relevant errors:" | tee -a ../build/logs/build.log
            grep -A 20 -B 5 -i "error\|fail\|exception" ../build/logs/gradle.log | tee -a ../build/logs/build.log || true
            exit 1
          }
          cd ..
          
          # Run Flutter build
          {
            flutter build apk --release --verbose 2>&1 | tee build/logs/flutter.log
          } || {
            echo "=== FLUTTER BUILD FAILED ===" | tee -a build/logs/build.log
            tail -n 50 build/logs/flutter.log | tee -a build/logs/build.log
            exit 1
          }

      # ======================
      # 5. ARTIFACT VERIFICATION
      # ======================
      - name: Verify and Package Artifacts
        script: |
          echo "=== Artifact Verification ==="
          if [ ! -d "build/app/outputs/flutter-apk" ]; then
            echo "ERROR: No APK directory found!"
            echo "Build outputs:"
            ls -la build/app/outputs/ || true
            exit 1
          fi
          
          mkdir -p build/outputs/apk
          if ls build/app/outputs/flutter-apk/*.apk >/dev/null 2>&1; then
            cp build/app/outputs/flutter-apk/*.apk build/outputs/apk/
            echo "APKs copied:"
            ls -lh build/outputs/apk/
          else
            echo "ERROR: No APK files found in build/app/outputs/flutter-apk/"
            echo "Directory contents:"
            ls -la build/app/outputs/flutter-apk/ || true
            echo "Build logs:"
            grep -i "error\|fail" build/logs/*.log || true
            exit 1
          fi

    artifacts:
      - build/outputs/apk/*.apk
      - build/logs/**
      - android/gradle/wrapper/gradle-wrapper.properties
      - android/build.gradle
      - android/app/build.gradle

    publishing:
      email:
        recipients:
          - your.email@example.com
      scripts:
        - name: Build Report
          script: |
            echo "=== BUILD DIAGNOSTICS ==="
            echo "Gradle version:"
            cat android/gradle/wrapper/gradle-wrapper.properties | grep "distributionUrl"
            echo "Android Gradle Plugin:"
            grep "com.android.tools.build:gradle" android/build.gradle
            echo "Java compatibility:"
            grep "sourceCompatibility" android/app/build.gradle || echo "Using default Java version"
            echo "Dependency conflicts:"
            grep -i "conflict\|incompatible" build/logs/dependencies.txt || echo "No conflicts found"
            echo "APK info:"
            ls -lh build/outputs/apk/